#!/usr/bin/env python

import argparse
from freesurfer.samseg import icv


# parse command line args
parser = argparse.ArgumentParser()
parser.add_argument('-i', '--input', metavar='FILE', help="file containing samseg stats", required=True)
parser.add_argument('-o', '--output', metavar='FILE', help="output file")
parser.add_argument('-m', '--map', metavar="FILE", help="file containing a list over intracranial structure labels."
                    "Label names must be identical to those defined in the atlas used by samseg. A default is used, if omitted.")
args = parser.parse_args()

# read in structure names and volumes from samseg stats 
structures = []
with open(args.input) as fid:
    for line in fid.readlines():
        name, vol, _ = line.split(',')
        _, _, name = name.split(' ')
        structures.append([name.strip(), float(vol)])

# read in structure names that are considered intra-cranial
includeStructures = None
if args.map:
    with open(args.map) as fid: includeStructures = [line.strip() for line in fid.readlines()]

# compute intra-cranial volume
sbtiv = icv(structures, includeStructures)

# write out and exit
print('intracranial volume: %.6f mm^3' % sbtiv)
if args.output:
  with open(os.path.join(args.output, 'sbtiv.stats'), 'w') as fid:
      fid.write('# Measure Intra-Cranial, %.6f, mm^3\n' % sbtiv)
